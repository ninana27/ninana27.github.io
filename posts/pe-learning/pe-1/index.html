<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PE文件结构学习0x01 - 深入DOS Header并将其打印 | 27's blog</title>
<meta name=keywords content><meta name=description content="介绍
上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 DOS Header，并用 C 语言打印详细信息。
DOS Header
概述
PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 IMAGE_DOS_HEADER。我们可以借助 PE-bear 查看DOS Header这部分：

这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：


向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）


指出真正的 PE 头（NT Header）在文件中的位置


IMAGE_DOS_HEADER
IMAGE_DOS_HEADER是一个 64 字节长的结构体，我们可以在 Windows SDK 的 winnt.h 头文件中找到 IMAGE_DOS_HEADER
的结构定义：
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // File address of new exe header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。"><meta name=author content="ninana27"><link rel=canonical href=https://ninana27.github.io/posts/pe-learning/pe-1/><link crossorigin=anonymous href=/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css integrity="sha256-bammPSWpYIvKL3+QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as=style><link rel=icon href=https://ninana27.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ninana27.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ninana27.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ninana27.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ninana27.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ninana27.github.io/posts/pe-learning/pe-1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://ninana27.github.io/posts/pe-learning/pe-1/"><meta property="og:site_name" content="27's blog"><meta property="og:title" content="PE文件结构学习0x01 - 深入DOS Header并将其打印"><meta property="og:description" content="介绍 上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 DOS Header，并用 C 语言打印详细信息。
DOS Header 概述 PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 IMAGE_DOS_HEADER。我们可以借助 PE-bear 查看DOS Header这部分：
这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：
向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）
指出真正的 PE 头（NT Header）在文件中的位置
IMAGE_DOS_HEADER IMAGE_DOS_HEADER是一个 64 字节长的结构体，我们可以在 Windows SDK 的 winnt.h 头文件中找到 IMAGE_DOS_HEADER 的结构定义：
typedef struct _IMAGE_DOS_HEADER { // DOS .EXE header WORD e_magic; // Magic number WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words LONG e_lfanew; // File address of new exe header } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; 这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-24T08:20:52-05:00"><meta property="article:modified_time" content="2025-04-24T08:20:52-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PE文件结构学习0x01 - 深入DOS Header并将其打印"><meta name=twitter:description content="介绍
上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 DOS Header，并用 C 语言打印详细信息。
DOS Header
概述
PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 IMAGE_DOS_HEADER。我们可以借助 PE-bear 查看DOS Header这部分：

这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：


向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）


指出真正的 PE 头（NT Header）在文件中的位置


IMAGE_DOS_HEADER
IMAGE_DOS_HEADER是一个 64 字节长的结构体，我们可以在 Windows SDK 的 winnt.h 头文件中找到 IMAGE_DOS_HEADER
的结构定义：
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // File address of new exe header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ninana27.github.io/posts/"},{"@type":"ListItem","position":2,"name":"PE文件结构学习0x01 - 深入DOS Header并将其打印","item":"https://ninana27.github.io/posts/pe-learning/pe-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PE文件结构学习0x01 - 深入DOS Header并将其打印","name":"PE文件结构学习0x01 - 深入DOS Header并将其打印","description":"介绍 上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 DOS Header，并用 C 语言打印详细信息。\nDOS Header 概述 PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 IMAGE_DOS_HEADER。我们可以借助 PE-bear 查看DOS Header这部分：\n这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：\n向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）\n指出真正的 PE 头（NT Header）在文件中的位置\nIMAGE_DOS_HEADER IMAGE_DOS_HEADER是一个 64 字节长的结构体，我们可以在 Windows SDK 的 winnt.h 头文件中找到 IMAGE_DOS_HEADER 的结构定义：\ntypedef struct _IMAGE_DOS_HEADER { // DOS .EXE header WORD e_magic; // Magic number WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words LONG e_lfanew; // File address of new exe header } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; 这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。\n","keywords":[],"articleBody":"介绍 上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 DOS Header，并用 C 语言打印详细信息。\nDOS Header 概述 PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 IMAGE_DOS_HEADER。我们可以借助 PE-bear 查看DOS Header这部分：\n这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：\n向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）\n指出真正的 PE 头（NT Header）在文件中的位置\nIMAGE_DOS_HEADER IMAGE_DOS_HEADER是一个 64 字节长的结构体，我们可以在 Windows SDK 的 winnt.h 头文件中找到 IMAGE_DOS_HEADER 的结构定义：\ntypedef struct _IMAGE_DOS_HEADER { // DOS .EXE header WORD e_magic; // Magic number WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words LONG e_lfanew; // File address of new exe header } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; 这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。\n关键字段解析 e_magic：\n类型：WORD（2 字节）\n值：0x5A4D（ASCII 为 MZ），是一个 Magic number\n功能：标志该文件是有效的 DOS/PE 可执行文件\ne_lfanew：\n类型：DWORD（4 字节）\n值：偏移量（例如 0x000000E8）\n功能：指向 NT Header 的起始位置（即 PE Signature 的位置）\n打印 DOS Header 基于上文我们对 DOS Header 的结构 IMAGE_DOS_HEADER 的了解，接下来就开始通过 C 语言编程来打印它的详细信息。 大致流程如下：\n读取文件 判断是否为有效的 PE 文件 打印出 DOS Header 的详细信息 类型定义 使用 stdint.h 中的数据类型自定义 BYTE，WORD，DWORD，QWORD 类型：\n#include typedef uint8_t BYTE; // unsigned char typedef uint16_t WORD; // unsigned short typedef uint32_t DWORD; // unsigned int typedef uint64_t QWORD; // unsigned long long 定义结构体类型 IMAGE_DOS_HEADER，仿照 winnt.h 中的定义，使用 #pragma pack(push, 1) 设置结构体按照1字节对齐，防止结构体中间出现填充字节（padding），以确保读取的二进制数据和文件结构完全一致：\n#pragma pack(push, 1) // Set current alignment to 1 byte // 64-byte long typedef struct _IMAGE_DOS_HEADER { // DOS .EXE header WORD e_magic; // Magic number 0x5A4D \"MZ\" WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words DWORD e_lfanew; // File address of new exe header } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; #pragma pack(pop) // Restore previous alignment settings 实现功能 读取文件，使用命令行将目标文件路径作为参数传入程序：\nint main(int argc, char *argv[]) { if (argc != 2) { printf(\"Usage: %s \", argv[0]); return 1; } FILE *fp = fopen(argv[1], \"rb\"); if (fp == NULL) { perror(\"Error opening file\"); return -1; } IMAGE_DOS_HEADER dos_header; // printf(\"size of IMAGE_DOS_HEADER: %lu bytes\\n\", sizeof(IMAGE_DOS_HEADER)); if (fread(\u0026dos_header, sizeof(IMAGE_DOS_HEADER), 1, fp) != 1) { perror(\"Error reading DOS header\"); fclose(fp); return -1; } ... } 通过判断前两个字节是否为 0x5A4D（“MZ”），来校验该文件是否为有效的 PE 文件：\nif (dos_header.e_magic != IMAGE_DOS_SIGNATURE) // #define IMAGE_DOS_SIGNATURE 0x5A4D { printf(\"Not a valid PE file (e_magic error)\\n\"); fclose(fp); return -1; } 打印出 DOS Header 的详细信息，定义一个打印函数，IMAGE_DOS_HEADER 结构体指针 PIMAGE_DOS_HEADER 作为参数：\nvoid print_dos_header_info(const PIMAGE_DOS_HEADER dos_header) { printf(\"Dos Header Info\\n\"); printf(\"--------------------------------\\n\"); printf(\"e_magic: 0x%04X\\n\", dos_header-\u003ee_magic); printf(\"e_cblp: 0x%04X\\n\", dos_header-\u003ee_cblp); printf(\"e_cp: 0x%04X\\n\", dos_header-\u003ee_cp); printf(\"e_crlc: 0x%04X\\n\", dos_header-\u003ee_crlc); printf(\"e_cparhdr: 0x%04X\\n\", dos_header-\u003ee_cparhdr); printf(\"e_minallco: 0x%04X\\n\", dos_header-\u003ee_minalloc); printf(\"e_maxalloc: 0x%04X\\n\", dos_header-\u003ee_maxalloc); printf(\"e_ss: 0x%04X\\n\", dos_header-\u003ee_ss); printf(\"e_sp: 0x%04X\\n\", dos_header-\u003ee_sp); printf(\"e_csum: 0x%04X\\n\", dos_header-\u003ee_csum); printf(\"e_ip: 0x%04X\\n\", dos_header-\u003ee_ip); printf(\"e_cs: 0x%04X\\n\", dos_header-\u003ee_cs); printf(\"e_lfarlc: 0x%04X\\n\", dos_header-\u003ee_lfarlc); printf(\"e_ovno: 0x%04X\\n\", dos_header-\u003ee_ovno); printf(\"e_res[4]:\\n\"); printf(\"[0]: 0x%04X\\t\", dos_header-\u003ee_res[0]); printf(\"[1]: 0x%04X\\t\", dos_header-\u003ee_res[1]); printf(\"[2]: 0x%04X\\t\", dos_header-\u003ee_res[2]); printf(\"[3]: 0x%04X\\n\", dos_header-\u003ee_res[3]); printf(\"e_oemid: 0x%04X\\n\", dos_header-\u003ee_oemid); printf(\"e_oeminfo: 0x%04X\\n\", dos_header-\u003ee_oeminfo); printf(\"e_res2[10]:\\n\"); printf(\"[0]: 0x%04X\\t\", dos_header-\u003ee_res2[0]); printf(\"[1]: 0x%04X\\t\", dos_header-\u003ee_res2[1]); printf(\"[2]: 0x%04X\\t\", dos_header-\u003ee_res2[2]); printf(\"[3]: 0x%04X\\t\", dos_header-\u003ee_res2[3]); printf(\"[4]: 0x%04X\\n\", dos_header-\u003ee_res2[4]); printf(\"[5]: 0x%04X\\t\", dos_header-\u003ee_res2[5]); printf(\"[6]: 0x%04X\\t\", dos_header-\u003ee_res2[6]); printf(\"[7]: 0x%04X\\t\", dos_header-\u003ee_res2[7]); printf(\"[8]: 0x%04X\\t\", dos_header-\u003ee_res2[8]); printf(\"[9]: 0x%04X\\n\", dos_header-\u003ee_res2[9]); printf(\"e_lfanew: 0x%08X\\n\", dos_header-\u003ee_lfanew); printf(\"--------------------------------\\n\\n\"); } 实际中我们只需要打印出关键字段 e_magic 和 e_lfanew，这里打印出全部信息只为加深对 DOS Header 结构的印象。\n直接打印关键字段：\nprintf(\"Dos Header\\n\"); printf(\"----------------\\n\"); printf(\"e_magic: 0x%X\\n\", dos_header.e_magic); printf(\"e_lfanew (PE header offset): 0x%X\\n\", dos_header.e_lfanew); 测试及结果 运行程序： 使用PE工具检查是否解析正确： 很好，是正确的。\n完整代码 #include #include typedef uint8_t BYTE; typedef uint16_t WORD; typedef uint32_t DWORD; typedef uint64_t QWORD; #define IMAGE_DOS_SIGNATURE 0x5A4D #pragma pack(push, 1) // Set current alignment to 1 byte // 64-byte long typedef struct _IMAGE_DOS_HEADER { // DOS .EXE header WORD e_magic; // Magic number 0x5A4D \"MZ\" WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words DWORD e_lfanew; // File address of new exe header } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; #pragma pack(pop) // Restore previous alignment settings void print_dos_header_info(const PIMAGE_DOS_HEADER); int main(int argc, char *argv[]) { if (argc != 2) { printf(\"Usage: %s \", argv[0]); return 1; } FILE *fp = fopen(argv[1], \"rb\"); if (fp == NULL) { perror(\"Error opening file\"); return -1; } IMAGE_DOS_HEADER dos_header; // printf(\"size of IMAGE_DOS_HEADER: %lu bytes\\n\", sizeof(IMAGE_DOS_HEADER)); if (fread(\u0026dos_header, sizeof(IMAGE_DOS_HEADER), 1, fp) != 1) { perror(\"Error reading DOS header\"); fclose(fp); return -1; } if (dos_header.e_magic != IMAGE_DOS_SIGNATURE) { printf(\"Not a valid PE file (e_magic error)\\n\"); fclose(fp); return -1; } print_dos_header_info(\u0026dos_header); printf(\"Dos Header\\n\"); printf(\"----------------\\n\"); printf(\"e_magic: 0x%X\\n\", dos_header.e_magic); printf(\"e_lfanew: 0x%X\\n\", dos_header.e_lfanew); printf(\"--------------------------------\\n\\n\"); return 0; } void print_dos_header_info(const PIMAGE_DOS_HEADER dos_header) { printf(\"Dos Header Info\\n\"); printf(\"--------------------------------\\n\"); printf(\"e_magic: 0x%04X\\n\", dos_header-\u003ee_magic); printf(\"e_cblp: 0x%04X\\n\", dos_header-\u003ee_cblp); printf(\"e_cp: 0x%04X\\n\", dos_header-\u003ee_cp); printf(\"e_crlc: 0x%04X\\n\", dos_header-\u003ee_crlc); printf(\"e_cparhdr: 0x%04X\\n\", dos_header-\u003ee_cparhdr); printf(\"e_minallco: 0x%04X\\n\", dos_header-\u003ee_minalloc); printf(\"e_maxalloc: 0x%04X\\n\", dos_header-\u003ee_maxalloc); printf(\"e_ss: 0x%04X\\n\", dos_header-\u003ee_ss); printf(\"e_sp: 0x%04X\\n\", dos_header-\u003ee_sp); printf(\"e_csum: 0x%04X\\n\", dos_header-\u003ee_csum); printf(\"e_ip: 0x%04X\\n\", dos_header-\u003ee_ip); printf(\"e_cs: 0x%04X\\n\", dos_header-\u003ee_cs); printf(\"e_lfarlc: 0x%04X\\n\", dos_header-\u003ee_lfarlc); printf(\"e_ovno: 0x%04X\\n\", dos_header-\u003ee_ovno); printf(\"e_res[4]:\\n\"); printf(\"[0]: 0x%04X\\t\", dos_header-\u003ee_res[0]); printf(\"[1]: 0x%04X\\t\", dos_header-\u003ee_res[1]); printf(\"[2]: 0x%04X\\t\", dos_header-\u003ee_res[2]); printf(\"[3]: 0x%04X\\n\", dos_header-\u003ee_res[3]); printf(\"e_oemid: 0x%04X\\n\", dos_header-\u003ee_oemid); printf(\"e_oeminfo: 0x%04X\\n\", dos_header-\u003ee_oeminfo); printf(\"e_res2[10]:\\n\"); printf(\"[0]: 0x%04X\\t\", dos_header-\u003ee_res2[0]); printf(\"[1]: 0x%04X\\t\", dos_header-\u003ee_res2[1]); printf(\"[2]: 0x%04X\\t\", dos_header-\u003ee_res2[2]); printf(\"[3]: 0x%04X\\t\", dos_header-\u003ee_res2[3]); printf(\"[4]: 0x%04X\\n\", dos_header-\u003ee_res2[4]); printf(\"[5]: 0x%04X\\t\", dos_header-\u003ee_res2[5]); printf(\"[6]: 0x%04X\\t\", dos_header-\u003ee_res2[6]); printf(\"[7]: 0x%04X\\t\", dos_header-\u003ee_res2[7]); printf(\"[8]: 0x%04X\\t\", dos_header-\u003ee_res2[8]); printf(\"[9]: 0x%04X\\n\", dos_header-\u003ee_res2[9]); printf(\"e_lfanew: 0x%08X\\n\", dos_header-\u003ee_lfanew); printf(\"--------------------------------\\n\\n\"); } 总结 本篇我们成功读取并解析了 PE 文件结构的第一部分 —— DOS Header。虽然这部分在运行时不会起核心作用，但它为我们指向了真正的 PE Header，是解析 PE 的第一步。\n","wordCount":"1043","inLanguage":"en","datePublished":"2025-04-24T08:20:52-05:00","dateModified":"2025-04-24T08:20:52-05:00","author":{"@type":"Person","name":"ninana27"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ninana27.github.io/posts/pe-learning/pe-1/"},"publisher":{"@type":"Organization","name":"27's blog","logo":{"@type":"ImageObject","url":"https://ninana27.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ninana27.github.io/ accesskey=h title="27's blog (Alt + H)">27's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ninana27.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://ninana27.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ninana27.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ninana27.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">PE文件结构学习0x01 - 深入DOS Header并将其打印</h1><div class=post-meta><span title='2025-04-24 08:20:52 -0500 CDT'>April 24, 2025</span>&nbsp;·&nbsp;ninana27</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#dos-header>DOS Header</a><ul><li><a href=#概述>概述</a></li><li><a href=#image_dos_header>IMAGE_DOS_HEADER</a></li><li><a href=#关键字段解析>关键字段解析</a></li></ul></li><li><a href=#打印-dos-header>打印 DOS Header</a><ul><li><a href=#类型定义>类型定义</a></li><li><a href=#实现功能>实现功能</a></li><li><a href=#测试及结果>测试及结果</a></li><li><a href=#完整代码>完整代码</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></details></div><div class=post-content><h2 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h2><p>上一篇文章我们简要地介绍了PE文件结构，这篇文章将深入学习它的第一部分 <strong>DOS Header</strong>，并用 C 语言打印详细信息。</p><h2 id=dos-header>DOS Header<a hidden class=anchor aria-hidden=true href=#dos-header>#</a></h2><h3 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h3><p>PE 文件起源于 MS-DOS 可执行文件格式，因此保留了一个兼容结构 —— DOS Header（也称为 MS-DOS Header ），是一个 64 字节长的结构，即 <code>IMAGE_DOS_HEADER</code>。我们可以借助 <code>PE-bear</code> 查看DOS Header这部分：</p><p><img alt="DOS Header" loading=lazy src=/images/pe-learning/pe-1-1.png></p><p>这部分在现代 Windows 程序中虽然已不再负责运行程序的主要功能，但仍然起到两个重要作用：</p><ul><li><p>向后兼容 MS-DOS 系统（在 MS-DOS 模式下运行时，会运行 DOS Stub 里的 DOS 程序）</p></li><li><p>指出真正的 PE 头（NT Header）在文件中的位置</p></li></ul><h3 id=image_dos_header>IMAGE_DOS_HEADER<a hidden class=anchor aria-hidden=true href=#image_dos_header>#</a></h3><p><code>IMAGE_DOS_HEADER</code>是一个 64 字节长的结构体，我们可以在 Windows SDK 的 <code>winnt.h</code> 头文件中找到 IMAGE_DOS_HEADER
的结构定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DOS_HEADER</span> <span class=p>{</span>      <span class=c1>// DOS .EXE header
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_magic</span><span class=p>;</span>                     <span class=c1>// Magic number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cblp</span><span class=p>;</span>                      <span class=c1>// Bytes on last page of file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cp</span><span class=p>;</span>                        <span class=c1>// Pages in file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_crlc</span><span class=p>;</span>                      <span class=c1>// Relocations
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cparhdr</span><span class=p>;</span>                   <span class=c1>// Size of header in paragraphs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_minalloc</span><span class=p>;</span>                  <span class=c1>// Minimum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_maxalloc</span><span class=p>;</span>                  <span class=c1>// Maximum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ss</span><span class=p>;</span>                        <span class=c1>// Initial (relative) SS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_sp</span><span class=p>;</span>                        <span class=c1>// Initial SP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_csum</span><span class=p>;</span>                      <span class=c1>// Checksum
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ip</span><span class=p>;</span>                        <span class=c1>// Initial IP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cs</span><span class=p>;</span>                        <span class=c1>// Initial (relative) CS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_lfarlc</span><span class=p>;</span>                    <span class=c1>// File address of relocation table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ovno</span><span class=p>;</span>                      <span class=c1>// Overlay number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>                    <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oemid</span><span class=p>;</span>                     <span class=c1>// OEM identifier (for e_oeminfo)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oeminfo</span><span class=p>;</span>                   <span class=c1>// OEM information; e_oemid specific
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res2</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>                  <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>LONG</span>   <span class=n>e_lfanew</span><span class=p>;</span>                    <span class=c1>// File address of new exe header
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=n>IMAGE_DOS_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DOS_HEADER</span><span class=p>;</span>
</span></span></code></pre></div><p>这段结构体包含多个字段，对于 PE 文件在 MS-DOS 模式下运行时非常重要，但接下来不会介绍所有的字段，只介绍几个关键的字段。</p><h3 id=关键字段解析>关键字段解析<a hidden class=anchor aria-hidden=true href=#关键字段解析>#</a></h3><p><code>e_magic</code>：</p><ul><li><p>类型：WORD（2 字节）</p></li><li><p>值：0x5A4D（ASCII 为 MZ），是一个 Magic number</p></li><li><p>功能：标志该文件是有效的 DOS/PE 可执行文件</p></li></ul><p><code>e_lfanew</code>：</p><ul><li><p>类型：DWORD（4 字节）</p></li><li><p>值：偏移量（例如 0x000000E8）</p></li><li><p>功能：指向 NT Header 的起始位置（即 PE Signature 的位置）</p></li></ul><h2 id=打印-dos-header>打印 DOS Header<a hidden class=anchor aria-hidden=true href=#打印-dos-header>#</a></h2><p>基于上文我们对 DOS Header 的结构 <code>IMAGE_DOS_HEADER</code> 的了解，接下来就开始通过 C 语言编程来打印它的详细信息。
大致流程如下：</p><ol><li>读取文件</li><li>判断是否为有效的 PE 文件</li><li>打印出 DOS Header 的详细信息</li></ol><h3 id=类型定义>类型定义<a hidden class=anchor aria-hidden=true href=#类型定义>#</a></h3><p>使用 <code>stdint.h</code> 中的数据类型自定义 <code>BYTE</code>，<code>WORD</code>，<code>DWORD</code>，<code>QWORD</code> 类型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>uint8_t</span>   <span class=n>BYTE</span><span class=p>;</span>     <span class=c1>// unsigned char     
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=kt>uint16_t</span>  <span class=n>WORD</span><span class=p>;</span>     <span class=c1>// unsigned short
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=kt>uint32_t</span>  <span class=n>DWORD</span><span class=p>;</span>    <span class=c1>// unsigned int
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=kt>uint64_t</span>  <span class=n>QWORD</span><span class=p>;</span>    <span class=c1>// unsigned long long
</span></span></span></code></pre></div><p>定义结构体类型 <code>IMAGE_DOS_HEADER</code>，仿照 <code>winnt.h</code> 中的定义，使用 <code>#pragma pack(push, 1)</code> 设置结构体按照1字节对齐，防止结构体中间出现填充字节（padding），以确保读取的二进制数据和文件结构完全一致：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#pragma pack(push, 1)   </span><span class=c1>// Set current alignment to 1 byte
</span></span></span><span class=line><span class=cl><span class=c1>// 64-byte long
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DOS_HEADER</span> <span class=p>{</span>      <span class=c1>// DOS .EXE header
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_magic</span><span class=p>;</span>                     <span class=c1>// Magic number 0x5A4D &#34;MZ&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cblp</span><span class=p>;</span>                      <span class=c1>// Bytes on last page of file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cp</span><span class=p>;</span>                        <span class=c1>// Pages in file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_crlc</span><span class=p>;</span>                      <span class=c1>// Relocations
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cparhdr</span><span class=p>;</span>                   <span class=c1>// Size of header in paragraphs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_minalloc</span><span class=p>;</span>                  <span class=c1>// Minimum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_maxalloc</span><span class=p>;</span>                  <span class=c1>// Maximum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ss</span><span class=p>;</span>                        <span class=c1>// Initial (relative) SS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_sp</span><span class=p>;</span>                        <span class=c1>// Initial SP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_csum</span><span class=p>;</span>                      <span class=c1>// Checksum
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ip</span><span class=p>;</span>                        <span class=c1>// Initial IP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cs</span><span class=p>;</span>                        <span class=c1>// Initial (relative) CS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_lfarlc</span><span class=p>;</span>                    <span class=c1>// File address of relocation table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ovno</span><span class=p>;</span>                      <span class=c1>// Overlay number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>                    <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oemid</span><span class=p>;</span>                     <span class=c1>// OEM identifier (for e_oeminfo)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oeminfo</span><span class=p>;</span>                   <span class=c1>// OEM information; e_oemid specific
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res2</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>                  <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>  <span class=n>e_lfanew</span><span class=p>;</span>                    <span class=c1>// File address of new exe header
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=n>IMAGE_DOS_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DOS_HEADER</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#pragma pack(pop)   </span><span class=c1>// Restore previous alignment settings 
</span></span></span></code></pre></div><h3 id=实现功能>实现功能<a hidden class=anchor aria-hidden=true href=#实现功能>#</a></h3><p>读取文件，使用命令行将目标文件路径作为参数传入程序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Usage: %s &lt;PE file path&gt;&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Error opening file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>IMAGE_DOS_HEADER</span> <span class=n>dos_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// printf(&#34;size of IMAGE_DOS_HEADER: %lu bytes\n&#34;, sizeof(IMAGE_DOS_HEADER));
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dos_header</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Error reading DOS header&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>通过判断前两个字节是否为 <code>0x5A4D</code>（&ldquo;MZ&rdquo;），来校验该文件是否为有效的 PE 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>dos_header</span><span class=p>.</span><span class=n>e_magic</span> <span class=o>!=</span> <span class=n>IMAGE_DOS_SIGNATURE</span><span class=p>)</span> <span class=c1>// #define IMAGE_DOS_SIGNATURE 0x5A4D
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Not a valid PE file (e_magic error)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>打印出 DOS Header 的详细信息，定义一个打印函数，<code>IMAGE_DOS_HEADER</code> 结构体指针 <code>PIMAGE_DOS_HEADER</code> 作为参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_dos_header_info</span><span class=p>(</span><span class=k>const</span> <span class=n>PIMAGE_DOS_HEADER</span> <span class=n>dos_header</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Dos Header Info</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_magic:        0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_magic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cblp:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cblp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cp:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_crlc:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_crlc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cparhdr:      0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cparhdr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_minallco:     0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_minalloc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_maxalloc:     0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_maxalloc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ss:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_sp:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_sp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_csum:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_csum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ip:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cs:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfarlc:       0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_lfarlc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ovno:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ovno</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_res[4]:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[0]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[1]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[2]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[3]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_oemid:        0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_oemid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_oeminfo:      0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_oeminfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_res2[10]:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[0]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[1]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[2]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[3]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[4]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[5]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[6]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>6</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[7]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>7</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[8]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>8</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[9]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>9</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfanew:       0x%08X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--------------------------------</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>实际中我们只需要打印出关键字段 <code>e_magic</code> 和 <code>e_lfanew</code>，这里打印出全部信息只为加深对 <code>DOS Header</code> 结构的印象。</p><p>直接打印关键字段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Dos Header</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;----------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_magic: 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=p>.</span><span class=n>e_magic</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfanew (PE header offset): 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=p>.</span><span class=n>e_lfanew</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=测试及结果>测试及结果<a hidden class=anchor aria-hidden=true href=#测试及结果>#</a></h3><p>运行程序：
<img alt=test loading=lazy src=/images/pe-learning/pe-1-2.png></p><p>使用PE工具检查是否解析正确：
<img alt=check loading=lazy src=/images/pe-learning/pe-1-3.png></p><p>很好，是正确的。</p><h3 id=完整代码>完整代码<a hidden class=anchor aria-hidden=true href=#完整代码>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>uint8_t</span>   <span class=n>BYTE</span><span class=p>;</span>     
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>uint16_t</span>  <span class=n>WORD</span><span class=p>;</span>     
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>uint32_t</span>  <span class=n>DWORD</span><span class=p>;</span>    
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>uint64_t</span>  <span class=n>QWORD</span><span class=p>;</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define IMAGE_DOS_SIGNATURE 0x5A4D
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#pragma pack(push, 1)   </span><span class=c1>// Set current alignment to 1 byte
</span></span></span><span class=line><span class=cl><span class=c1>// 64-byte long
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DOS_HEADER</span> <span class=p>{</span>      <span class=c1>// DOS .EXE header
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_magic</span><span class=p>;</span>                     <span class=c1>// Magic number 0x5A4D &#34;MZ&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cblp</span><span class=p>;</span>                      <span class=c1>// Bytes on last page of file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cp</span><span class=p>;</span>                        <span class=c1>// Pages in file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_crlc</span><span class=p>;</span>                      <span class=c1>// Relocations
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cparhdr</span><span class=p>;</span>                   <span class=c1>// Size of header in paragraphs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_minalloc</span><span class=p>;</span>                  <span class=c1>// Minimum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_maxalloc</span><span class=p>;</span>                  <span class=c1>// Maximum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ss</span><span class=p>;</span>                        <span class=c1>// Initial (relative) SS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_sp</span><span class=p>;</span>                        <span class=c1>// Initial SP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_csum</span><span class=p>;</span>                      <span class=c1>// Checksum
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ip</span><span class=p>;</span>                        <span class=c1>// Initial IP value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_cs</span><span class=p>;</span>                        <span class=c1>// Initial (relative) CS value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_lfarlc</span><span class=p>;</span>                    <span class=c1>// File address of relocation table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_ovno</span><span class=p>;</span>                      <span class=c1>// Overlay number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>                    <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oemid</span><span class=p>;</span>                     <span class=c1>// OEM identifier (for e_oeminfo)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_oeminfo</span><span class=p>;</span>                   <span class=c1>// OEM information; e_oemid specific
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>   <span class=n>e_res2</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>                  <span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>  <span class=n>e_lfanew</span><span class=p>;</span>                    <span class=c1>// File address of new exe header
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_DOS_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DOS_HEADER</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#pragma pack(pop)   </span><span class=c1>// Restore previous alignment settings 
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_dos_header_info</span><span class=p>(</span><span class=k>const</span> <span class=n>PIMAGE_DOS_HEADER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Usage: %s &lt;PE file path&gt;&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Error opening file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>IMAGE_DOS_HEADER</span> <span class=n>dos_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// printf(&#34;size of IMAGE_DOS_HEADER: %lu bytes\n&#34;, sizeof(IMAGE_DOS_HEADER));
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dos_header</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Error reading DOS header&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dos_header</span><span class=p>.</span><span class=n>e_magic</span> <span class=o>!=</span> <span class=n>IMAGE_DOS_SIGNATURE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Not a valid PE file (e_magic error)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>print_dos_header_info</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dos_header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Dos Header</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;----------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_magic: 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=p>.</span><span class=n>e_magic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfanew: 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=p>.</span><span class=n>e_lfanew</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--------------------------------</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_dos_header_info</span><span class=p>(</span><span class=k>const</span> <span class=n>PIMAGE_DOS_HEADER</span> <span class=n>dos_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Dos Header Info</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_magic:        0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_magic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cblp:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cblp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cp:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_crlc:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_crlc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cparhdr:      0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cparhdr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_minallco:     0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_minalloc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_maxalloc:     0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_maxalloc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ss:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_sp:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_sp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_csum:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_csum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ip:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_cs:           0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_cs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfarlc:       0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_lfarlc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_ovno:         0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_ovno</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_res[4]:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[0]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[1]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[2]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[3]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_oemid:        0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_oemid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_oeminfo:      0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_oeminfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_res2[10]:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[0]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[1]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[2]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[3]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[4]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[5]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[6]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>6</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[7]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>7</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[8]: 0x%04X</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>8</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[9]: 0x%04X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_res2</span><span class=p>[</span><span class=mi>9</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;e_lfanew:       0x%08X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dos_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--------------------------------</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>本篇我们成功读取并解析了 PE 文件结构的第一部分 —— DOS Header。虽然这部分在运行时不会起核心作用，但它为我们指向了真正的 PE Header，是解析 PE 的第一步。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://ninana27.github.io/posts/pe-learning/pe-0/><span class=title>Next »</span><br><span>PE文件结构学习0x00 - 初识PE</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ninana27.github.io/>27's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>